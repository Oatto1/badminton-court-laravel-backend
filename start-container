#!/usr/bin/env bash

if [ ! -z "$WWWUSER" ]; then
    usermod -u $WWWUSER sail
fi

if [ ! -d /.composer ]; then
    mkdir /.composer
fi

chmod -R u=rwX,g=rX,o= /.composer

# Install composer dependencies if vendor/autoload.php is missing
if [ ! -f /var/www/html/vendor/autoload.php ]; then
    cd /var/www/html
    composer install --no-interaction --prefer-dist --optimize-autoloader
fi

# Generate .env if missing
if [ ! -f /var/www/html/.env ]; then
    cp /var/www/html/.env.example /var/www/html/.env
    php /var/www/html/artisan key:generate
fi

if [ ! -d /var/www/html/public/storage ]; then
    php /var/www/html/artisan storage:link
fi

if [ ! -d /var/www/html/storage/app/public ]; then
    php /var/www/html/artisan storage:link
fi

# Wait for PostgreSQL to be ready before running migrations
echo "Waiting for PostgreSQL..."
until php /var/www/html/artisan db:monitor --databases=pgsql > /dev/null 2>&1; do
    sleep 2
done
echo "PostgreSQL is ready."

# Run migrations (without dropping existing data)
php /var/www/html/artisan migrate --force

# Fix storage permissions
chown -R sail:sail /var/www/html/storage /var/www/html/bootstrap/cache
chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache

exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
